# Loss 발산 문제 및 데이터 전처리

---

### loc_Loss가 발산하는 미스테리한 현상을 해결하기 위해 고민했던 요소들을 공유하고자 글을 작성합니다.

---
#### 1. train-all-20.txt 파일에는 문제가 없는지 확인하기 위해서 다시한번 json을 꼼꼼히 검토를 먼저 했습니다 (8963개 image파일)

  - category_id 가 -1로 설정된 box만 존재하는 **(person을 가리키는 box들이 없는 image)** 225개의 image는 제거를 해야했습니다. 결국 8738개 image파일만 남게 됨
  
  - 나머지 이미지들 중에서도 **category_id가 -1로** 설정된 박스들 또한 제거를 해야 했습니다. 즉 , 새롭게 만들 json에는 오로지 label이 1만 존재하도록 box들을 제거
  
  - 이러한 처리를 거쳐갔다면 Train_data 내에서는 category_id가 -1로 설정된 box들은 존재하지 않게 됩니다.
  

#### 2. get_item 함수에서 이미지의 index를 반환하도록 Code를 수정했습니다.

  - 나중에 발산하는 이미지의 index를 확인하기 위해 Code를 수정했습니다. collate_fn 에서도 index list를 반환해줘야 합니다.
  

#### 3. 좀 더 간편히 확인하기 위해 batch_size를 1로 조정한뒤 이미지를 한장 한장 확인했습니다.


#### 4. transform의 영향을 받지 않기 위해 split 인자를 'TEST'로 넘겨주고 epoch를 한번만 돌려봤습니다.

  - split 인자를 'TEST'로 넘겨주면 , 이미지를 자르거나 회전시키거나 그런 random한 전처리 과정이 일어나지 않기 때문에 순수한 image 와 box들을 전달해주게 됩니다.
  

#### 5. 발산하는 이미지의 index를 담아줄 list를 하나 만들어주고 loss가 발산 할 때마다 그 이미지의 index를 list에 담아줬습니다.

  - math.isnan 이나 math.isinf 를 활용해서 index를 담아주었습니다.
  
  
#### 6. 한번의 epoch가 끝나자 8장의 이미지를 확인할 수 있었고 , 혹시나 해서 초기화 시킨뒤 epoch를 처음부터 다시 한번 더 돌려봤습니다.

  - 같은 index가 반환되는 것을 확인했고 , 때문에 "특정한 image들이 문제를 일으키고 있구나" 라고 판단하게 됐습니다.
  
  - Index : 1009 , 1475 , 2371 , 3093 , 6522 , 7615 , 7616 , 7617 (수정된 json 에서의 index이므로 기존 8963개가 달린 image와는 순서가 다릅니다.)
  
  
#### 7. 발산된 image들을 detection 하여 box들의 상태를 확인했습니다.

---

## inf 로 발산한 image 와 box

- set00/set00/V004/lwir/I01233.jpg
- boxes : [531, 235, 590, 397], **[620, 308, 620, 309]**, [600, 233, 664, 389]

![1009](https://user-images.githubusercontent.com/70448161/108629751-c5632600-74a4-11eb-98c2-71d58f9a3a69.jpg)

- set00/set00/V007/lwir/I00263.jpg
- boxes : [290, 213, 303, 244], [225, 213, 257, 291], [248, 213, 282, 295], [263, 214, 295, 291], **[167, 262, 167, 263]**, [151, 211, 178, 265]

![1475](https://user-images.githubusercontent.com/70448161/108629752-c6945300-74a4-11eb-9365-1a6e91ad2ad4.jpg)

- set01/set01/V000/lwir/I02017.jpg
- boxes : **[434, 241, 434, 242]**, [107, 221, 166, 346], [267, 225, 314, 328], [300, 216, 344, 323]

![2371](https://user-images.githubusercontent.com/70448161/108629753-c6945300-74a4-11eb-8f32-c702a5731f56.jpg)

- set01/set01/V003/lwir/I00905.jpg
- boxes : [390, 236, 439, 355], **[164, 322, 164, 323]**, **[151, 305, 151, 306]**, **[149, 258, 149, 259]**, [105, 231, 180, 415]

![3093](https://user-images.githubusercontent.com/70448161/108629754-c72ce980-74a4-11eb-84a1-676fdd1a1ab8.jpg)

- set03/set03/V001/lwir/I01005.jpg
- boxes : [430, 226, 461, 291], [452, 221, 484, 293], **[497, 230, 497, 231]**, [476, 225, 514, 318]

![6522](https://user-images.githubusercontent.com/70448161/108629755-c72ce980-74a4-11eb-81c8-00a44645560c.jpg)

- set04/set04/V001/lwir/I01229.jpg
- boxes : **[529, 282, 529, 283]**, [242, 222, 285, 328], [553, 212, 596, 318], [291, 221, 332, 320], [348, 226, 384, 313], [573, 200, 612, 295]

![7615](https://user-images.githubusercontent.com/70448161/108629756-c7c58000-74a4-11eb-8541-1ed4f4a64ab1.jpg)

- set04/set04/V001/lwir/I01231.jpg
- boxes : **[529, 282, 529, 283]**, [242, 222, 285, 328], [298, 222, 339, 321], [353, 223, 391, 316], [581, 205, 616, 291], [553, 212, 596, 318]


![7616](https://user-images.githubusercontent.com/70448161/108629757-c7c58000-74a4-11eb-8581-3f29629fa9f5.jpg)

- set04/set04/V001/lwir/I01233.jpg
- boxes : [251, 223, 294, 329], [310, 220, 352, 322], [363, 226, 399, 314], **[529, 282, 529, 283]**, [561, 210, 607, 322], [584, 204, 621, 294]

![7617](https://user-images.githubusercontent.com/70448161/108629758-c85e1680-74a4-11eb-8f3d-c5634f424161.jpg)

---
- 문제가 된 image 들을 확인하면 box가 이상하게 쳐져 있는 걸 확인할 수 있는데

- 같이 올려둔 box들의 좌표들을 확인해보면 Ex)  **[620, 308, 620, 309]** , **[167, 262, 167, 263]** 등등 **left_top , right_down 좌표들이 같거나 거의 동일한 box**들을 확인 할 수 있고

- **이러한 box들이 문제를 일으킨 것이다** 라고 결론내렸습니다.

- 저 8개의 image들만 delete를 시켜준뒤 train을 돌려보면 Loss 예외처리 없이 , Loss가 발산하는 것을 해결할 수 있었습니다.

---

